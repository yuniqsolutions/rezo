const { CookieJar: TouchCookieJar, Cookie: TouchCookie } = require("tough-cookie");

class Cookie extends TouchCookie {
  constructor(options) {
    super(options);
    this.fixDateFields();
  }
  fixDateFields() {
    if (this.creation && typeof this.creation === "string") {
      this.creation = new Date(this.creation);
    }
    if (this.lastAccessed && typeof this.lastAccessed === "string") {
      this.lastAccessed = new Date(this.lastAccessed);
    }
    if (this.expires && typeof this.expires === "string" && this.expires !== "Infinity") {
      this.expires = new Date(this.expires);
    }
  }
  getExpires() {
    let expires = 0;
    if (this.expires && typeof this.expires !== "string") {
      expires = Math.round(this.expires.getTime() / 1000);
    } else if (this.maxAge) {
      if (this.maxAge === "Infinity") {
        expires = 2147483647;
      } else if (this.maxAge === "-Infinity") {
        expires = 0;
      } else if (typeof this.maxAge === "number") {
        expires = Math.round(Date.now() / 1000 + this.maxAge);
      }
    }
    return expires;
  }
  toNetscapeFormat() {
    const domain = !this.hostOnly ? this.domain.startsWith(".") ? this.domain : "." + this.domain : this.domain;
    const secure = this.secure ? "TRUE" : "FALSE";
    const expires = this.getExpires();
    return `${domain}	TRUE	${this.path}	${secure}	${expires}	${this.key}	${this.value}`;
  }
  toSetCookieString() {
    let str = this.cookieString();
    if (this.expires instanceof Date) {
      str += `; Expires=${this.expires.toUTCString()}`;
    }
    if (this.maxAge != null) {
      str += `; Max-Age=${this.maxAge}`;
    }
    if (this.domain) {
      str += `; Domain=${this.domain}`;
    }
    if (this.path) {
      str += `; Path=${this.path}`;
    }
    if (this.secure) {
      str += "; Secure";
    }
    if (this.httpOnly) {
      str += "; HttpOnly";
    }
    if (this.sameSite) {
      str += `; SameSite=${this.sameSite}`;
    }
    if (this.extensions) {
      str += `; ${this.extensions.join("; ")}`;
    }
    return str;
  }
  getURL() {
    if (!this.domain) {
      return;
    }
    const protocol = this.secure ? "https://" : "http://";
    const domain = this.domain.startsWith(".") ? this.domain.substring(1) : this.domain;
    const path = this.path || "/";
    return `${protocol}${domain}${path}`;
  }
  static isCookie(cookie) {
    return cookie instanceof Cookie || cookie instanceof TouchCookie;
  }
}

class RezoCookieJar extends TouchCookieJar {
  constructor(store, options) {
    if (Array.isArray(store)) {
      super();
    } else {
      super(store, typeof options !== "string" ? options : undefined);
    }
    if (Array.isArray(store) && store.length > 0 && Cookie.isCookie(store[0])) {
      if (options && typeof options === "string") {
        this.setCookiesSync(store, options);
      } else {
        this.setCookiesSync(store);
      }
    }
  }
  generateCookies(data) {
    const cookies = !data ? (this.toJSON()?.cookies || []).map((cookie) => new Cookie(cookie)) : data[0] instanceof Cookie ? data : data.map((cookie) => new Cookie(cookie instanceof TouchCookie ? cookie : Cookie.fromJSON(cookie)));
    const netscape = cookies.map((cookie) => cookie.toNetscapeFormat());
    const cookieString = cookies.map((cookie) => cookie.cookieString());
    const setCookiesString = cookies.map((cookie) => cookie.toSetCookieString());
    let netscapeString = `# Netscape HTTP Cookie File
`;
    netscapeString += `# This file was generated by Rezo HTTP client
`;
    netscapeString += `# Based on uniqhtt cookie implementation
`;
    netscapeString += netscape.join(`
`) || "";
    return {
      array: cookies,
      serialized: this.toJSON()?.cookies || [],
      netscape: netscapeString,
      string: cookieString.join("; "),
      setCookiesString
    };
  }
  cookies() {
    return this.generateCookies();
  }
  parseResponseCookies(cookies) {
    return this.generateCookies(cookies);
  }
  static toNetscapeCookie(cookies) {
    cookies = cookies.map((cookie) => {
      return cookie instanceof Cookie ? cookie : new Cookie(Cookie.fromJSON(cookie));
    });
    let netscapeString = `# Netscape HTTP Cookie File
`;
    netscapeString += `# This file was generated by Rezo HTTP client
`;
    netscapeString += `# Based on uniqhtt cookie implementation
`;
    netscapeString += cookies.map((cookie) => cookie.toNetscapeFormat()).join(`
`) || "";
    return netscapeString;
  }
  static toCookieString(cookies) {
    cookies = cookies.map((cookie) => {
      return cookie instanceof Cookie ? cookie : new Cookie(Cookie.fromJSON(cookie));
    });
    return cookies.map((cookie) => cookie.toNetscapeFormat()).join("; ") || "";
  }
  toCookieString() {
    return this.cookies().string;
  }
  toNetscapeCookie() {
    return this.cookies().netscape;
  }
  toArray() {
    return this.cookies().array;
  }
  toSetCookies() {
    return this.cookies().setCookiesString;
  }
  toSerializedCookies() {
    return this.cookies().serialized;
  }
  setCookiesSync(cookiesData, url) {
    const cookies = [];
    if (Array.isArray(cookiesData)) {
      cookiesData.forEach((c) => {
        const cookie = c instanceof Cookie ? c : typeof c === "string" ? new Cookie(Cookie.parse(c)) : new Cookie(Cookie.fromJSON(c));
        let isFailed = 0;
        while (isFailed < 2) {
          try {
            if (cookie) {
              const _url = isFailed > 0 ? cookie.getURL() || url || this.getUrlFromCookie(cookie) : url || this.getUrlFromCookie(cookie);
              if (_url) {
                const __cookie = this.setCookieSync(cookie, _url);
                if (__cookie) {
                  cookies.push(__cookie);
                }
              }
              isFailed = 4;
              break;
            } else {
              isFailed++;
            }
          } catch (error) {
            isFailed++;
            if (isFailed > 1) {
              break;
            }
          }
        }
      });
    } else if (typeof cookiesData === "string") {
      if (cookiesData.includes(",") && (cookiesData.includes("=") && (cookiesData.includes(";") || cookiesData.includes("expires=") || cookiesData.includes("path=")))) {
        const setCookieStrings = this.splitSetCookiesString(cookiesData);
        setCookieStrings.forEach((cookieStr) => {
          const cookie = new Cookie(Cookie.parse(cookieStr));
          let isFailed = 0;
          while (isFailed < 2) {
            try {
              if (cookie) {
                const _url = isFailed > 0 ? cookie.getURL() || url || this.getUrlFromCookie(cookie) : url || this.getUrlFromCookie(cookie);
                if (_url) {
                  const __cookie = this.setCookieSync(cookie, _url);
                  if (__cookie) {
                    cookies.push(__cookie);
                  }
                }
                isFailed = 4;
                break;
              } else {
                isFailed++;
              }
            } catch (error) {
              isFailed++;
              if (isFailed > 1) {
                break;
              }
            }
          }
        });
      } else if (cookiesData.includes("=") && cookiesData.includes(";")) {
        const cookiePairs = cookiesData.split(";");
        cookiePairs.forEach((pair) => {
          const trimmedPair = pair.trim();
          if (trimmedPair) {
            const cookie = new Cookie({ key: trimmedPair.split("=")[0].trim(), value: trimmedPair.split("=")[1]?.trim() || "" });
            let isFailed = 0;
            while (isFailed < 2) {
              try {
                if (cookie) {
                  const _url = isFailed > 0 ? cookie.getURL() || url || this.getUrlFromCookie(cookie) : url || this.getUrlFromCookie(cookie);
                  if (_url) {
                    const __cookie = this.setCookieSync(cookie, _url);
                    if (__cookie) {
                      cookies.push(__cookie);
                    }
                  }
                  isFailed = 4;
                  break;
                } else {
                  isFailed++;
                }
              } catch (error) {
                isFailed++;
                if (isFailed > 1) {
                  break;
                }
              }
            }
          }
        });
      } else if (cookiesData.includes("\t") && /^\S+\t/.test(cookiesData)) {
        const netscapeCookies = this.parseNetscapeCookies(cookiesData);
        netscapeCookies.forEach((c) => {
          const cookie = new Cookie(c);
          let isFailed = 0;
          while (isFailed < 2) {
            try {
              if (cookie) {
                const _url = isFailed > 0 ? cookie.getURL() || url || this.getUrlFromCookie(cookie) : url || this.getUrlFromCookie(cookie);
                if (_url) {
                  const __cookie = this.setCookieSync(cookie, _url);
                  if (__cookie) {
                    cookies.push(__cookie);
                  }
                }
                isFailed = 4;
                break;
              } else {
                isFailed++;
              }
            } catch (error) {
              isFailed++;
              if (isFailed > 1) {
                break;
              }
            }
          }
        });
      } else if (cookiesData.includes("=")) {
        const cookie = new Cookie(Cookie.parse(cookiesData));
        let isFailed = 0;
        while (isFailed < 2) {
          try {
            if (cookie) {
              const _url = isFailed > 0 ? cookie.getURL() || url || this.getUrlFromCookie(cookie) : url || this.getUrlFromCookie(cookie);
              if (_url) {
                const __cookie = this.setCookieSync(cookie, _url);
                if (__cookie) {
                  cookies.push(__cookie);
                }
              }
              isFailed = 4;
              break;
            } else {
              isFailed++;
            }
          } catch (error) {
            isFailed++;
            if (isFailed > 1) {
              break;
            }
          }
        }
      }
    }
    return this.generateCookies(cookies);
  }
  splitSetCookiesString(cookiesString) {
    const result = [];
    let currentCookie = "";
    let withinValue = false;
    for (let i = 0;i < cookiesString.length; i++) {
      const char = cookiesString[i];
      if (char === "," && !withinValue) {
        result.push(currentCookie.trim());
        currentCookie = "";
        continue;
      }
      if (char === "=") {
        withinValue = true;
      } else if (char === ";") {
        withinValue = false;
      }
      currentCookie += char;
    }
    if (currentCookie.trim()) {
      result.push(currentCookie.trim());
    }
    return result;
  }
  getUrlFromCookie(cookie) {
    if (!cookie.domain) {
      return;
    }
    const proto = cookie.secure ? "https://" : "http://";
    const domain = cookie.domain.startsWith(".") ? cookie.domain.substring(1) : cookie.domain;
    const pathname = cookie.path || "/";
    return `${proto}${domain}${pathname}`;
  }
  parseNetscapeCookies = (cookieText) => {
    const lines = cookieText.split(`
`).filter((line) => line.trim() !== "" && !line.startsWith("#"));
    return lines.map((line) => {
      const parts = line.split("\t");
      if (parts.length < 7) {
        throw new Error(`Invalid Netscape cookie format: ${line}`);
      }
      const [domain, _, path, secureStr, expiresStr, name, value] = parts;
      let expires = null;
      if (expiresStr !== "0" && expiresStr !== "") {
        expires = new Date(parseInt(expiresStr, 10) * 1000);
      }
      return {
        domain,
        path,
        secure: secureStr.toUpperCase() === "TRUE",
        expires,
        key: name,
        value,
        httpOnly: false,
        sameSite: undefined
      };
    });
  };
  static netscapeCookiesToSetCookieArray(netscapeCookieText) {
    const parseNetscapeCookies = (cookieText) => {
      const lines = cookieText.split(`
`).filter((line) => line.trim() !== "" && !line.startsWith("#"));
      return lines.map((line) => {
        const parts = line.split("\t");
        if (parts.length < 7) {
          throw new Error(`Invalid Netscape cookie format: ${line}`);
        }
        const [domain, _, path, secureStr, expiresStr, name, value] = parts;
        let expires = null;
        if (expiresStr !== "0" && expiresStr !== "") {
          expires = new Date(parseInt(expiresStr, 10) * 1000);
        }
        return {
          domain,
          path,
          secure: secureStr.toUpperCase() === "TRUE",
          expires,
          name,
          value,
          httpOnly: false,
          sameSite: undefined
        };
      });
    };
    const cookieToSetCookieString = (cookie) => {
      let setCookie = `${cookie.name}=${cookie.value}`;
      if (cookie.domain) {
        setCookie += `; Domain=${cookie.domain}`;
      }
      if (cookie.path) {
        setCookie += `; Path=${cookie.path}`;
      }
      if (cookie.expires) {
        setCookie += `; Expires=${cookie.expires.toUTCString()}`;
      }
      if (cookie.secure) {
        setCookie += "; Secure";
      }
      if (cookie.httpOnly) {
        setCookie += "; HttpOnly";
      }
      if (cookie.sameSite) {
        setCookie += `; SameSite=${cookie.sameSite}`;
      }
      return setCookie;
    };
    try {
      const cookies = parseNetscapeCookies(netscapeCookieText);
      return cookies.map(cookieToSetCookieString);
    } catch (error) {
      return [];
    }
  }
  [Symbol.for("nodejs.util.inspect.custom")]() {
    const cookies = this.cookies();
    return {
      cookies: cookies.array.map((c) => ({
        name: c.key,
        value: c.value,
        domain: c.domain,
        path: c.path,
        expires: c.expires instanceof Date ? c.expires.toISOString() : c.expires,
        secure: c.secure,
        httpOnly: c.httpOnly,
        sameSite: c.sameSite
      })),
      count: cookies.array.length
    };
  }
  _cookieFile;
  get cookieFile() {
    return this._cookieFile;
  }
  loadFromFile(filePath, defaultUrl) {
    const fs = require("node:fs");
    if (!fs.existsSync(filePath)) {
      this._cookieFile = filePath;
      return;
    }
    const content = fs.readFileSync(filePath, "utf-8");
    const isJson = filePath.toLowerCase().endsWith(".json");
    const store = this.store;
    const putCookieSync = (cookie) => {
      let done = false;
      let error = null;
      store.putCookie(cookie, (err) => {
        error = err;
        done = true;
      });
      if (error)
        throw error;
    };
    if (isJson) {
      try {
        const data = JSON.parse(content);
        const cookies = Array.isArray(data) ? data : data.cookies || [];
        for (const c of cookies) {
          try {
            const cookie = new Cookie(Cookie.fromJSON(c));
            if (cookie && cookie.key && cookie.domain) {
              putCookieSync(cookie);
            }
          } catch (e) {}
        }
      } catch (e) {}
    } else {
      const setCookieStrings = RezoCookieJar.netscapeCookiesToSetCookieArray(content);
      for (const cookieStr of setCookieStrings) {
        try {
          const cookie = new Cookie(Cookie.parse(cookieStr));
          if (cookie && cookie.key && cookie.domain) {
            putCookieSync(cookie);
          }
        } catch (e) {}
      }
    }
    this._cookieFile = filePath;
  }
  saveToFile(filePath) {
    const targetPath = filePath || this._cookieFile;
    if (!targetPath) {
      throw new Error("No cookie file path specified. Provide a path or load from a file first.");
    }
    const fs = require("node:fs");
    const isJson = targetPath.toLowerCase().endsWith(".json");
    const cookies = this.cookies();
    if (isJson) {
      const data = {
        version: 1,
        cookies: cookies.serialized
      };
      fs.writeFileSync(targetPath, JSON.stringify(data, null, 2));
    } else {
      fs.writeFileSync(targetPath, cookies.netscape);
    }
    if (filePath) {
      this._cookieFile = filePath;
    }
  }
  static fromFile(filePath, defaultUrl) {
    const jar = new RezoCookieJar;
    jar.loadFromFile(filePath, defaultUrl);
    return jar;
  }
}
const CookieJar = exports.CookieJar = RezoCookieJar;

exports.Cookie = Cookie;
exports.RezoCookieJar = RezoCookieJar;